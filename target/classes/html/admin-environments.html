<!-- src/main/resources/html/admin-environments.html -->
<!DOCTYPE html>
<html>
<head>
    <title data-i18n="adminEnvironments.title">Manage Environments</title>
    <link rel="stylesheet" type="text/css" href="app/dist/guacamole.css">
    <script type="text/javascript" src="app/dist/guacamole-common-js/modules/guacamole-common.js"></script>
</head>
<body class="guac-body">
    <div class="login-dialog">
        <h1 id="admin-environments-heading" data-i18n="adminEnvironments.heading">Manage Target Environments</h1>

        <!-- Form for adding/editing environments -->
        <form id="environment-form">
            <input type="hidden" id="environment-id">
            <div class="form-group">
                <label for="environment-name" data-i18n="adminEnvironments.name">Name</label>
                <input type="text" id="environment-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="environment-description" data-i18n="adminEnvironments.description">Description</label>
                <textarea id="environment-description" class="form-control" rows="2"></textarea>
            </div>
            <button type="submit" id="save-button" class="button" data-i18n="adminEnvironments.save">Save Environment</button>
            <button type="button" id="cancel-button" class="button" data-i18n="adminEnvironments.cancel" style="display: none;">Cancel Edit</button>
        </form>

        <hr>

        <!-- Table for listing environments -->
        <h2 data-i18n="adminEnvironments.existing">Existing Environments</h2>
        <table class="list-table">
            <thead>
                <tr>
                    <th data-i18n="adminEnvironments.name">Name</th>
                    <th data-i18n="adminEnvironments.description">Description</th>
                    <th data-i18n="adminEnvironments.actions">Actions</th>
                </tr>
            </thead>
            <tbody id="environments-table-body">
                <!-- Environments will be dynamically loaded here -->
            </tbody>
        </table>
        <div id="status-message" class="status-message" style="display: none;"></div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const token = Guacamole.Authentication.getToken();
            const apiUrl = 'api/ext/request-portal/environments';

            const form = document.getElementById('environment-form');
            const tableBody = document.getElementById('environments-table-body');
            const statusDiv = document.getElementById('status-message');
            const envIdField = document.getElementById('environment-id');
            const envNameField = document.getElementById('environment-name');
            const envDescField = document.getElementById('environment-description');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');

            function showStatus(message, isError = false) {
                statusDiv.textContent = message;
                statusDiv.className = isError ? 'status-message error' : 'status-message success';
                statusDiv.style.display = 'block';
            }

            function resetForm() {
                form.reset();
                envIdField.value = '';
                saveButton.textContent = 'Save Environment'; // data-i18n
                cancelButton.style.display = 'none';
            }

            function loadEnvironments() {
                fetch(`${apiUrl}?token=${token}`)
                    .then(response => response.ok ? response.json() : Promise.reject('Failed to load environments.'))
                    .then(environments => {
                        tableBody.innerHTML = '';
                        if (environments.length === 0) {
                            const row = tableBody.insertRow();
                            const cell = row.insertCell(0);
                            cell.colSpan = 3;
                            cell.textContent = 'No environments configured.'; // data-i18n
                            cell.style.textAlign = 'center';
                        } else {
                            environments.forEach(env => {
                                const row = tableBody.insertRow();
                                row.insertCell(0).textContent = env.name;
                                row.insertCell(1).textContent = env.description;

                                const actionsCell = row.insertCell(2);
                                const editButton = document.createElement('button');
                                editButton.textContent = 'Edit'; // data-i18n
                                editButton.className = 'button';
                                editButton.onclick = () => {
                                    envIdField.value = env.environmentId;
                                    envNameField.value = env.name;
                                    envDescField.value = env.description;
                                    saveButton.textContent = 'Update Environment'; // data-i18n
                                    cancelButton.style.display = 'inline-block';
                                    window.scrollTo(0, 0);
                                };

                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete'; // data-i18n
                                deleteButton.className = 'button';
                                deleteButton.onclick = () => {
                                    if (confirm(`Are you sure you want to delete "${env.name}"?`)) {
                                        fetch(`${apiUrl}/${env.environmentId}?token=${token}`, { method: 'DELETE' })
                                            .then(response => {
                                                if (!response.ok) return Promise.reject('Failed to delete.');
                                                showStatus('Environment deleted successfully.');
                                                loadEnvironments();
                                            })
                                            .catch(err => showStatus(err, true));
                                    }
                                };
                                actionsCell.appendChild(editButton);
                                actionsCell.appendChild(deleteButton);
                            });
                        }
                    })
                    .catch(err => showStatus(err, true));
            }

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const id = envIdField.value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${apiUrl}/${id}?token=${token}` : `${apiUrl}?token=${token}`;

                const environment = {
                    name: envNameField.value,
                    description: envDescField.value
                };

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(environment)
                })
                .then(response => {
                    if (!response.ok) return Promise.reject(`Failed to ${id ? 'update' : 'create'} environment.`);
                    showStatus(`Environment ${id ? 'updated' : 'created'} successfully.`);
                    resetForm();
                    loadEnvironments();
                })
                .catch(err => showStatus(err, true));
            });

            cancelButton.addEventListener('click', resetForm);

            // Initial load
            loadEnvironments();
        });
    </script>
</body>
</html>
